x-common-env-variables: &common-env-variables
  BACALHAU_DISABLEANALYTICS: "true"
  LOG_LEVEL: info

services:
  compute:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    hostname: compute-${HOSTNAME:-node}
    command: serve -c /etc/bacalhau/config.yaml
    environment: *common-env-variables
    network_mode: "host"
    volumes:
      - /etc/bacalhau/config.yaml:/etc/bacalhau/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp:/tmp
      - /opt/sensor/data:/opt/sensor/data:ro
      - /opt/sensor/exports:/opt/sensor/exports:ro
      - /root/.aws:/root/.aws:ro  # AWS credentials for S3 access
      - /home/ubuntu/.aws:/home/bacalhau/.aws:ro  # Alternative mount for bacalhau user
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bacalhau", "version"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 15s
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
